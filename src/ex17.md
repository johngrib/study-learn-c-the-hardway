# 17.2 힙 할당 vs 스택 할당

91쪽.

> 그동안 여러분은 아주 즐거운 나날을 보냈다고 해도 과언이 아니다.
루비나 파이썬을 사용하던 시절에는 그저 오브젝트와 변수만 만들었을 뿐,
이것들이 과연 어디에 있는지에 대해서는 전혀 신경 쓰지 않았을 것이다.
조금 더 자세히 말하자면 오브젝트나 변수들이 스택에 있는지 힙에 있는지에 대해 고려하지 않았다는 것이다.
그리고 사실은 알 필요도 없었다.
그저 여러분이 선택한 프로그래밍 언어들은 절대로 스택에 변수를 넣지 않고 모두 힙에 넣고 있었으며,
이마저도 여러분은 전혀 모르고 있었을 것이다.
>
> 하지만 C 언어는 다르다.
왜냐하면 C 언어는 CPU와 기계에 직접 접근할 수 있기 때문이다.
기계는 메모리를 포함하고 있으며, 메모리는 곧 스택과 힙을 의미한다.
그렇다면 스택과 힙의 차이는 무엇인가?
바로 데이터가 저장되는 위치다.
>
> 힙(heap)을 설명하는 것이 더 쉬운데, 그 이유는 컴퓨터에서 사용하지 않는 모든 메모리를 의미하기 때문이다.
여러분은 이 공간에 접근하기 위해 `malloc` 함수를 사용한다.
`malloc`을 호출할 때마다 운영체제는 내부 함수를 실행하여 여러분에게 제공하기 위해 필요한 공간만큼을 할당하고
그 포인터를 돌려준다.
그리고 메모리 사용이 끝나면 `free`를 사용하여 메모리를 운영체제에 반납해 다른 프로그램이 사용할 수 있도록 한다.
만일 메모리 반납이 이루어지지 않는다면 여러분의 프로그램은 메모리 누수(leak memory)를 일으킬 것이다.
하지만 Valgrind가 이러한 누수를 찾는 데 도움을 줄 것이다.
>
> 스택(stack)은 메모리 내 특별한 공간으로 이 안에는 임시로 사용되는 변수,
즉 함수 내에서 사용되는 지역 변수들이 저장된다.
함수로 전달되는 인수들이 스택에 push된 후 함수 내에서 사용되는 것이 기본 동작 방법이다.
이것은 자료 구조에서 설명하는 스택과 동일하게(마지막에 들어간 것이 제일 먼저 나오는 형태로) 동작한다.
이 규칙은 `char action`과 `int id` 등과 같이 `main` 함수 내에서 선언되는 지역 변수에도 동일하게 적용된다.
스택의 장점은 함수가 끝날 때 그 진가를 발휘한다.
함수가 끝날 때 C 컴파일러가 스택에 저장된 모든 변수를 `pop`하여 스택을 완전히 비우는 것이다.
이렇게 간단한 작업 만으로도 메모리 누수를 예방할 수 있다.
>
> 힙과 스택을 구분하는 가장 쉬운 공식은 다음과 같다.
만일 변수든 함수든 `malloc`을 통해 가져온 것이 아니라면 모두 스택에 있다.
스택과 힙에는 세 가지 주요 문제가 있다.
>
- `malloc`을 통해 메모리 블록을 얻으면서 이를 가리키는 포인터가 스택에 저장되었다면, 함수가 종료되는 순간 포인터도 `pop`되어 사라지면서 할당 받은 메모리 블록도 찾을 수 없게 될 것이다.
- 스택에 과다한 양의 데이터를 넣으면 (대규모 구조체 및 배열 등) 스택 오버플로(stack overflow)를 일으키면서 프로그램이 강제 종료될 것이다. 이러한 경우네는 `malloc`을 통해 힙을 사용토록 해야 한다.
- 만일 스택에 저장된 무언가를 가리키는 포인터를 사용하다가 함수로부터 이 포인터를 넘기거나 반환시키는 경우 이 포인터를 받는 함수는 세그먼테이션 오류(segmentation fault, segfault)를 일으킬 것이다. 왜냐하면 포인터가 가리키는 실제 데이터는 `pop`되어 보이지 않을 것이기 때문이다. 즉, 죽은 공간을 가리키고 있는 것이다.
>
> 이것이 `Database_open`이 메모리를 할당받도록 하고 (혹은 할당받지 못하고 죽거나) `Database_close`가 모든 것을 반납시키도록 만든 이유이다.
생성 함수를 작성했다면 반드시 이어서 제거 함수도 작성하여 만들어낸 것들을 안전하게 정리하도록 하자.
이것이 메모리를 쉽게 관리할 수 있는 방법이자 팁이다.
>
> 최종적으로 프로그램이 종료할 때 운영체제는 프로그램이 사용했던 모든 자원을 정리한다(즉시 정리하지 않는 경우도 가끔은 있다).
이에 대한 격언도 있는데(이번 연습에서도 사용했다) "그냥 프로그램을 강제로 종료시켜 운영체제로 하여금 오류 난 부분을 정리토록 만들어라"이다.
